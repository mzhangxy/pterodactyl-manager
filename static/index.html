<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿¼é¾™é¢æ¿æ–‡ä»¶ç®¡ç†å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; margin-bottom: 20px; color: #00d4ff; }
        
        /* é…ç½®é¢æ¿ */
        .config-panel { background: #16213e; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .config-panel h2 { margin-bottom: 15px; font-size: 18px; }
        .config-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
        .config-group { flex: 1; min-width: 200px; }
        .config-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #aaa; }
        .config-group input { width: 100%; padding: 10px; border: 1px solid #333; border-radius: 5px; background: #0f0f23; color: #fff; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-primary { background: #00d4ff; color: #000; }
        .btn-primary:hover { background: #00a8cc; }
        .btn-success { background: #00c853; color: #fff; }
        .btn-danger { background: #ff1744; color: #fff; }
        .btn-secondary { background: #666; color: #fff; }
        
        /* å·¥å…·æ  */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .breadcrumb { background: #16213e; padding: 10px 15px; border-radius: 5px; flex: 1; }
        .breadcrumb span { cursor: pointer; color: #00d4ff; }
        .breadcrumb span:hover { text-decoration: underline; }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-manager { background: #16213e; border-radius: 10px; overflow: hidden; }
        .file-header { display: grid; grid-template-columns: 40px 1fr 100px 150px 180px; padding: 15px; background: #0f3460; font-weight: bold; }
        .file-item { display: grid; grid-template-columns: 40px 1fr 100px 150px 180px; padding: 12px 15px; border-bottom: 1px solid #333; align-items: center; }
        .file-item:hover { background: #1f4068; }
        .file-item.selected { background: #0f3460; }
        .file-icon { font-size: 20px; }
        .file-name { cursor: pointer; word-break: break-all; }
        .file-name:hover { color: #00d4ff; }
        .file-actions { display: flex; gap: 5px; }
        .file-actions button { padding: 5px 10px; font-size: 12px; }
        
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #16213e; padding: 25px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #00d4ff; }
        .close-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
        .editor-textarea { width: 100%; height: 400px; background: #0f0f23; color: #0f0; border: 1px solid #333; border-radius: 5px; padding: 15px; font-family: monospace; font-size: 14px; resize: vertical; }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-zone { border: 2px dashed #00d4ff; border-radius: 10px; padding: 40px; text-align: center; margin-top: 20px; cursor: pointer; }
        .upload-zone:hover { background: rgba(0,212,255,0.1); }
        .upload-zone.dragover { background: rgba(0,212,255,0.2); }
        
        /* æ¶ˆæ¯æç¤º */
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 5px; color: #fff; z-index: 2000; animation: slideIn 0.3s; }
        .toast.success { background: #00c853; }
        .toast.error { background: #ff1744; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading { text-align: center; padding: 50px; color: #666; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 3px solid #333; border-top-color: #00d4ff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* å¤é€‰æ¡† */
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        
        /* æœåŠ¡å™¨æ§åˆ¶ */
        .server-control { background: #16213e; padding: 15px 20px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .server-status { display: flex; align-items: center; gap: 20px; }
        .server-status span { font-size: 14px; }
        #serverStatus { font-weight: bold; }
        #serverStatus.running { color: #00c853; }
        #serverStatus.offline { color: #ff1744; }
        #serverStatus.starting { color: #ffab00; }
        #serverStatus.stopping { color: #ffab00; }
        .power-buttons { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .power-buttons .btn { padding: 8px 15px; font-size: 13px; }
        .auto-restart-toggle { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #0f3460; border-radius: 5px; cursor: pointer; font-size: 13px; }
        .auto-restart-toggle input { width: 16px; height: 16px; cursor: pointer; }
        .auto-restart-toggle.active { background: #00c853; color: #000; }
        

    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦– ç¿¼é¾™é¢æ¿æ–‡ä»¶ç®¡ç†å™¨</h1>
        
        <!-- é…ç½®é¢æ¿ -->
        <div class="config-panel">
            <h2>âš™ï¸ API é…ç½®</h2>
            <div class="config-row">
                <div class="config-group">
                    <label>API åœ°å€</label>
                    <input type="text" id="apiUrl" placeholder="https://panel.example.com/api/client/servers">
                </div>
                <div class="config-group">
                    <label>Server ID</label>
                    <input type="text" id="serverId" placeholder="abc123">
                </div>
                <div class="config-group">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="ptlc_xxxxxx">
                </div>
                <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
        
        <!-- æœåŠ¡å™¨æ§åˆ¶ -->
        <div class="server-control">
            <div class="server-status">
                <span id="serverStatus">âšª æœªçŸ¥</span>
                <span id="serverResources"></span>
            </div>
            <div class="power-buttons">
                <button class="btn btn-success" onclick="powerAction('start')">â–¶ï¸ å¼€æœº</button>
                <button class="btn btn-primary" onclick="powerAction('restart')">ğŸ”„ é‡å¯</button>
                <button class="btn btn-danger" onclick="powerAction('stop')">â¹ï¸ å…³æœº</button>
                <button class="btn btn-secondary" onclick="powerAction('kill')">âš ï¸ å¼ºåˆ¶ç»ˆæ­¢</button>
                <button class="btn btn-secondary" onclick="showCommandModal()">ğŸ’» æ§åˆ¶å°</button>

                <label class="auto-restart-toggle">
                    <input type="checkbox" id="autoRestartToggle" onchange="toggleAutoRestart()">
                    <span>ğŸ” åœæœºè‡ªåŠ¨é‡å¯</span>
                </label>
            </div>
        </div>
        
        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <div class="breadcrumb" id="breadcrumb"></div>
            <button class="btn btn-primary" onclick="refreshFiles()">ğŸ”„ åˆ·æ–°</button>
            <button class="btn btn-success" onclick="showCreateFolder()">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</button>
            <button class="btn btn-success" onclick="showCreateFile()">ğŸ“„ æ–°å»ºæ–‡ä»¶</button>
            <button class="btn btn-primary" onclick="showUpload()">â¬†ï¸ ä¸Šä¼ </button>
            <button class="btn btn-danger" onclick="deleteSelected()">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
        </div>
        
        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="file-manager">
            <div class="file-header">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <span>æ–‡ä»¶å</span>
                <span>å¤§å°</span>
                <span>ä¿®æ”¹æ—¶é—´</span>
                <span>æ“ä½œ</span>
            </div>
            <div id="fileList">
                <div class="loading"><div class="spinner"></div><p>è¯·å…ˆé…ç½® API...</p></div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div class="modal" id="editorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editorTitle">ç¼–è¾‘æ–‡ä»¶</h3>
                <button class="close-btn" onclick="closeEditor()">&times;</button>
            </div>
            <textarea class="editor-textarea" id="editorContent"></textarea>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeEditor()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveFile()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¸Šä¼ æ–‡ä»¶</h3>
                <button class="close-btn" onclick="closeUpload()">&times;</button>
            </div>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <p>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileSelect(event)">
            </div>
            <div id="uploadProgress" style="margin-top:15px"></div>
        </div>
    </div>
    
    <!-- é‡å‘½å/æ–°å»ºæ¨¡æ€æ¡† -->
    <div class="modal" id="inputModal">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h3 id="inputTitle">è¾“å…¥</h3>
                <button class="close-btn" onclick="closeInput()">&times;</button>
            </div>
            <input type="text" id="inputValue" style="width:100%;padding:10px;background:#0f0f23;border:1px solid #333;border-radius:5px;color:#fff;margin-bottom:15px">
            <div style="text-align:right">
                <button class="btn btn-secondary" onclick="closeInput()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="inputConfirm">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- æ§åˆ¶å°æ¨¡æ€æ¡† -->
    <div class="modal" id="commandModal">
        <div class="modal-content" style="max-width:600px">
            <div class="modal-header">
                <h3>ğŸ’» å‘é€æ§åˆ¶å°å‘½ä»¤</h3>
                <button class="close-btn" onclick="closeCommandModal()">&times;</button>
            </div>
            <input type="text" id="commandInput" placeholder="è¾“å…¥å‘½ä»¤..." style="width:100%;padding:10px;background:#0f0f23;border:1px solid #333;border-radius:5px;color:#fff;margin-bottom:15px" onkeypress="if(event.key==='Enter')sendCommand()">
            <div style="text-align:right">
                <button class="btn btn-secondary" onclick="closeCommandModal()">å…³é—­</button>
                <button class="btn btn-primary" onclick="sendCommand()">å‘é€</button>
            </div>
        </div>
    </div>
    


    <script>
        let currentPath = '/';
        let currentEditFile = '';
        let files = [];
        
        // åˆå§‹åŒ–
        window.onload = async () => {
            loadConfig();
            setupDragDrop();
        };
        
        // ä» localStorage åŠ è½½é…ç½®
        function loadConfig() {
            const saved = localStorage.getItem('ptero_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    document.getElementById('apiUrl').value = config.api_url || '';
                    document.getElementById('serverId').value = config.server_id || '';
                    document.getElementById('apiKey').value = config.api_key || '';
                    if (config.api_url && config.server_id && config.api_key) {
                        refreshFiles();
                        getServerStatus();
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        }
        
        // ä¿å­˜é…ç½®åˆ° localStorage
        function saveConfig() {
            const config = {
                api_url: document.getElementById('apiUrl').value,
                server_id: document.getElementById('serverId').value,
                api_key: document.getElementById('apiKey').value
            };
            localStorage.setItem('ptero_config', JSON.stringify(config));
            showToast('é…ç½®å·²ä¿å­˜åˆ°æµè§ˆå™¨', 'success');
            refreshFiles();
            getServerStatus();
        }
        
        // è·å–é…ç½®
        function getConfig() {
            return {
                api_url: document.getElementById('apiUrl').value,
                server_id: document.getElementById('serverId').value,
                api_key: document.getElementById('apiKey').value
            };
        }
        
        // è·å–è¯·æ±‚å¤´
        function getHeaders() {
            const config = getConfig();
            return {
                'X-API-URL': config.api_url,
                'X-Server-ID': config.server_id,
                'X-API-Key': config.api_key
            };
        }
        
        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        async function refreshFiles() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            const config = getConfig();
            if (!config.api_url || !config.server_id || !config.api_key) {
                fileList.innerHTML = '<div class="loading"><p>è¯·å…ˆé…ç½® API...</p></div>';
                return;
            }
            
            try {
                const resp = await fetch(`/api/files/list?directory=${encodeURIComponent(currentPath)}`, {
                    headers: getHeaders()
                });
                const data = await resp.json();
                
                if (data.error) {
                    fileList.innerHTML = `<div class="loading"><p style="color:#ff1744">âŒ ${data.error}</p></div>`;
                    return;
                }
                
                files = data.data || [];
                renderFiles();
                updateBreadcrumb();
            } catch (e) {
                fileList.innerHTML = `<div class="loading"><p style="color:#ff1744">âŒ ${e.message}</p></div>`;
            }
        }
        
        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFiles() {
            const fileList = document.getElementById('fileList');
            if (files.length === 0) {
                fileList.innerHTML = '<div class="loading"><p>ğŸ“‚ æ–‡ä»¶å¤¹ä¸ºç©º</p></div>';
                return;
            }
            
            // æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰
            files.sort((a, b) => {
                if (a.attributes.is_file !== b.attributes.is_file) {
                    return a.attributes.is_file ? 1 : -1;
                }
                return a.attributes.name.localeCompare(b.attributes.name);
            });
            
            fileList.innerHTML = files.map((file, idx) => {
                const attr = file.attributes;
                const icon = attr.is_file ? 'ğŸ“„' : 'ğŸ“';
                const size = attr.is_file ? formatSize(attr.size) : '-';
                const time = new Date(attr.modified_at).toLocaleString();
                const escapedName = attr.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                    <div class="file-item" data-idx="${idx}">
                        <input type="checkbox" class="file-checkbox" data-name="${escapedName}">
                        <span class="file-name" onclick="handleClick(${idx})">${icon} ${attr.name}</span>
                        <span>${size}</span>
                        <span>${time}</span>
                        <div class="file-actions">
                            ${attr.is_file ? `<button class="btn btn-primary" onclick="editFile('${escapedName}')">ç¼–è¾‘</button>` : ''}
                            ${attr.is_file ? `<button class="btn btn-success" onclick="downloadFile('${escapedName}')">ä¸‹è½½</button>` : ''}
                            <button class="btn btn-secondary" onclick="renameFile('${escapedName}')">é‡å‘½å</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ›´æ–°é¢åŒ…å±‘
        function updateBreadcrumb() {
            const parts = currentPath.split('/').filter(p => p);
            let html = `<span onclick="navigateTo('/')">/æ ¹ç›®å½•</span>`;
            let path = '';
            for (const part of parts) {
                path += '/' + part;
                html += ` / <span onclick="navigateTo('${path}')">${part}</span>`;
            }
            document.getElementById('breadcrumb').innerHTML = html;
        }
        
        // å¯¼èˆªåˆ°ç›®å½•
        function navigateTo(path) {
            currentPath = path;
            refreshFiles();
        }
        
        // ç‚¹å‡»å¤„ç†
        function handleClick(idx) {
            const file = files[idx];
            if (!file.attributes.is_file) {
                currentPath = currentPath.replace(/\/$/, '') + '/' + file.attributes.name;
                refreshFiles();
            }
        }
        
        // ç¼–è¾‘æ–‡ä»¶
        async function editFile(name) {
            const filePath = currentPath.replace(/\/$/, '') + '/' + name;
            currentEditFile = filePath;
            
            try {
                const resp = await fetch(`/api/files/contents?file=${encodeURIComponent(filePath)}`, {
                    headers: getHeaders()
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    showToast('è¯»å–å¤±è´¥: ' + (err.error || resp.statusText), 'error');
                    return;
                }
                const content = await resp.text();
                document.getElementById('editorTitle').textContent = 'ç¼–è¾‘: ' + name;
                document.getElementById('editorContent').value = content;
                document.getElementById('editorModal').classList.add('active');
            } catch (e) {
                showToast('è¯»å–å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // ä¿å­˜æ–‡ä»¶
        async function saveFile() {
            const content = document.getElementById('editorContent').value;
            try {
                const headers = getHeaders();
                headers['Content-Type'] = 'text/plain';
                const resp = await fetch(`/api/files/write?file=${encodeURIComponent(currentEditFile)}`, {
                    method: 'POST',
                    headers: headers,
                    body: content
                });
                if (resp.ok) {
                    showToast('ä¿å­˜æˆåŠŸ', 'success');
                    closeEditor();
                    refreshFiles();
                } else {
                    const err = await resp.json();
                    showToast('ä¿å­˜å¤±è´¥: ' + (err.error || resp.statusText), 'error');
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        function closeEditor() {
            document.getElementById('editorModal').classList.remove('active');
        }
        
        // ä¸‹è½½æ–‡ä»¶
        async function downloadFile(name) {
            const filePath = currentPath.replace(/\/$/, '') + '/' + name;
            try {
                const resp = await fetch(`/api/files/download?file=${encodeURIComponent(filePath)}`, {
                    headers: getHeaders()
                });
                const data = await resp.json();
                if (data.attributes && data.attributes.url) {
                    window.open(data.attributes.url, '_blank');
                } else if (data.error) {
                    showToast('ä¸‹è½½å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('ä¸‹è½½å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // é‡å‘½åæ–‡ä»¶
        function renameFile(oldName) {
            showInput('é‡å‘½å', oldName, async (newName) => {
                if (!newName || newName === oldName) return;
                try {
                    const resp = await fetch('/api/files/rename', {
                        method: 'POST',
                        headers: {...getHeaders(), 'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            root: currentPath,
                            files: [{ from: oldName, to: newName }]
                        })
                    });
                    if (resp.ok) {
                        showToast('é‡å‘½åæˆåŠŸ', 'success');
                        refreshFiles();
                    } else {
                        const err = await resp.json();
                        showToast('é‡å‘½åå¤±è´¥: ' + (err.error || resp.statusText), 'error');
                    }
                } catch (e) {
                    showToast('é‡å‘½åå¤±è´¥: ' + e.message, 'error');
                }
            });
        }
        
        // æ–°å»ºæ–‡ä»¶å¤¹
        function showCreateFolder() {
            showInput('æ–°å»ºæ–‡ä»¶å¤¹', '', async (name) => {
                if (!name) return;
                try {
                    const resp = await fetch('/api/files/create-folder', {
                        method: 'POST',
                        headers: {...getHeaders(), 'Content-Type': 'application/json'},
                        body: JSON.stringify({ root: currentPath, name: name })
                    });
                    if (resp.ok) {
                        showToast('åˆ›å»ºæˆåŠŸ', 'success');
                        refreshFiles();
                    } else {
                        const err = await resp.json();
                        showToast('åˆ›å»ºå¤±è´¥: ' + (err.error || resp.statusText), 'error');
                    }
                } catch (e) {
                    showToast('åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
                }
            });
        }
        
        // æ–°å»ºæ–‡ä»¶
        function showCreateFile() {
            showInput('æ–°å»ºæ–‡ä»¶', '', async (name) => {
                if (!name) return;
                const filePath = currentPath.replace(/\/$/, '') + '/' + name;
                try {
                    const headers = getHeaders();
                    headers['Content-Type'] = 'text/plain';
                    const resp = await fetch(`/api/files/write?file=${encodeURIComponent(filePath)}`, {
                        method: 'POST',
                        headers: headers,
                        body: ''
                    });
                    if (resp.ok) {
                        showToast('åˆ›å»ºæˆåŠŸ', 'success');
                        refreshFiles();
                    } else {
                        const err = await resp.json();
                        showToast('åˆ›å»ºå¤±è´¥: ' + (err.error || resp.statusText), 'error');
                    }
                } catch (e) {
                    showToast('åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
                }
            });
        }
        
        // åˆ é™¤é€‰ä¸­
        async function deleteSelected() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const names = Array.from(checkboxes).map(cb => cb.dataset.name);
            if (names.length === 0) {
                showToast('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶', 'error');
                return;
            }
            if (!confirm(`ç¡®å®šåˆ é™¤ ${names.length} ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹ï¼Ÿ`)) return;
            
            try {
                const resp = await fetch('/api/files/delete', {
                    method: 'POST',
                    headers: {...getHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({ root: currentPath, files: names })
                });
                if (resp.ok) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    refreshFiles();
                } else {
                    const err = await resp.json();
                    showToast('åˆ é™¤å¤±è´¥: ' + (err.error || resp.statusText), 'error');
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // å…¨é€‰
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = checked);
        }
        
        // ä¸Šä¼ 
        function showUpload() {
            document.getElementById('uploadModal').classList.add('active');
            document.getElementById('uploadProgress').innerHTML = '';
        }
        
        function closeUpload() {
            document.getElementById('uploadModal').classList.remove('active');
        }
        
        function setupDragDrop() {
            const zone = document.getElementById('uploadZone');
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        }
        
        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }
        
        async function handleFiles(fileList) {
            const progress = document.getElementById('uploadProgress');
            
            for (const file of fileList) {
                progress.innerHTML += `<p>â¬†ï¸ æ­£åœ¨ä¸Šä¼ : ${file.name}...</p>`;
                
                const formData = new FormData();
                formData.append('files', file);
                
                try {
                    // é€šè¿‡åç«¯ä»£ç†ä¸Šä¼ 
                    // æ³¨æ„ï¼šFormData ä¸èƒ½è®¾ç½® Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
                    const config = getConfig();
                    const uploadResp = await fetch(`/api/files/upload?directory=${encodeURIComponent(currentPath)}`, {
                        method: 'POST',
                        headers: {
                            'X-API-URL': config.api_url,
                            'X-Server-ID': config.server_id,
                            'X-API-Key': config.api_key
                        },
                        body: formData
                    });
                    
                    if (uploadResp.ok) {
                        progress.innerHTML += `<p style="color:#00c853">âœ… ${file.name} ä¸Šä¼ æˆåŠŸ</p>`;
                    } else {
                        const err = await uploadResp.json();
                        progress.innerHTML += `<p style="color:#ff1744">âŒ ${file.name}: ${err.error || 'ä¸Šä¼ å¤±è´¥'}</p>`;
                    }
                } catch (e) {
                    progress.innerHTML += `<p style="color:#ff1744">âŒ ${file.name}: ${e.message}</p>`;
                }
            }
            
            refreshFiles();
        }
        
        // è¾“å…¥æ¡†
        function showInput(title, defaultValue, callback) {
            document.getElementById('inputTitle').textContent = title;
            document.getElementById('inputValue').value = defaultValue;
            document.getElementById('inputModal').classList.add('active');
            document.getElementById('inputValue').focus();
            
            document.getElementById('inputConfirm').onclick = () => {
                callback(document.getElementById('inputValue').value);
                closeInput();
            };
        }
        
        function closeInput() {
            document.getElementById('inputModal').classList.remove('active');
        }
        
        // æç¤º
        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // ==================== æœåŠ¡å™¨æ§åˆ¶ ====================
        
        // è·å–æœåŠ¡å™¨çŠ¶æ€
        async function getServerStatus() {
            const config = getConfig();
            if (!config.api_url || !config.server_id || !config.api_key) return;
            
            try {
                const resp = await fetch('/api/resources', { headers: getHeaders() });
                const data = await resp.json();
                
                if (data.attributes) {
                    const attr = data.attributes;
                    const state = attr.current_state || 'unknown';
                    const statusEl = document.getElementById('serverStatus');
                    const resourcesEl = document.getElementById('serverResources');
                    
                    const stateMap = {
                        'running': 'ğŸŸ¢ è¿è¡Œä¸­',
                        'offline': 'ğŸ”´ å·²å…³æœº',
                        'starting': 'ğŸŸ¡ å¯åŠ¨ä¸­',
                        'stopping': 'ğŸŸ¡ å…³é—­ä¸­'
                    };
                    
                    statusEl.textContent = stateMap[state] || 'âšª ' + state;
                    statusEl.className = state;
                    
                    // æ˜¾ç¤ºèµ„æº
                    if (attr.resources) {
                        const r = attr.resources;
                        const cpuPercent = (r.cpu_absolute || 0).toFixed(1);
                        const memMB = ((r.memory_bytes || 0) / 1024 / 1024).toFixed(0);
                        resourcesEl.textContent = `CPU: ${cpuPercent}% | å†…å­˜: ${memMB} MB`;
                    }
                    
                    // æ£€æŸ¥è‡ªåŠ¨é‡å¯
                    checkAutoRestart(state);
                }
            } catch (e) {
                console.error('Failed to get server status:', e);
            }
        }
        
        // ç”µæºæ“ä½œ
        async function powerAction(action) {
            const actionNames = {
                'start': 'å¼€æœº',
                'stop': 'å…³æœº', 
                'restart': 'é‡å¯',
                'kill': 'å¼ºåˆ¶ç»ˆæ­¢'
            };
            
            if (action === 'kill' && !confirm('ç¡®å®šè¦å¼ºåˆ¶ç»ˆæ­¢æœåŠ¡å™¨å—ï¼Ÿè¿™å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼')) return;
            
            try {
                const resp = await fetch('/api/power', {
                    method: 'POST',
                    headers: {...getHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({ signal: action })
                });
                
                if (resp.ok) {
                    showToast(`${actionNames[action]}å‘½ä»¤å·²å‘é€`, 'success');
                    setTimeout(getServerStatus, 2000);
                } else {
                    const err = await resp.json();
                    showToast(`${actionNames[action]}å¤±è´¥: ${err.error}`, 'error');
                }
            } catch (e) {
                showToast(`${actionNames[action]}å¤±è´¥: ${e.message}`, 'error');
            }
        }
        
        // æ§åˆ¶å°å‘½ä»¤
        function showCommandModal() {
            document.getElementById('commandModal').classList.add('active');
            document.getElementById('commandInput').focus();
        }
        
        function closeCommandModal() {
            document.getElementById('commandModal').classList.remove('active');
        }
        
        async function sendCommand() {
            const command = document.getElementById('commandInput').value.trim();
            if (!command) return;
            
            try {
                const resp = await fetch('/api/command', {
                    method: 'POST',
                    headers: {...getHeaders(), 'Content-Type': 'application/json'},
                    body: JSON.stringify({ command: command })
                });
                
                if (resp.ok) {
                    showToast('å‘½ä»¤å·²å‘é€', 'success');
                    document.getElementById('commandInput').value = '';
                } else {
                    const err = await resp.json();
                    showToast('å‘é€å¤±è´¥: ' + err.error, 'error');
                }
            } catch (e) {
                showToast('å‘é€å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        // å®šæ—¶åˆ·æ–°çŠ¶æ€
        setInterval(getServerStatus, 5000);
        
        // ==================== åœæœºè‡ªåŠ¨é‡å¯ ====================
        
        let autoRestartEnabled = false;
        let lastServerState = null;
        
        function toggleAutoRestart() {
            autoRestartEnabled = document.getElementById('autoRestartToggle').checked;
            const label = document.querySelector('.auto-restart-toggle');
            if (autoRestartEnabled) {
                label.classList.add('active');
                showToast('åœæœºè‡ªåŠ¨é‡å¯å·²å¼€å¯', 'success');
            } else {
                label.classList.remove('active');
                showToast('åœæœºè‡ªåŠ¨é‡å¯å·²å…³é—­', 'success');
            }
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('ptero_auto_restart', autoRestartEnabled ? '1' : '0');
        }
        
        function loadAutoRestartSetting() {
            const saved = localStorage.getItem('ptero_auto_restart');
            if (saved === '1') {
                autoRestartEnabled = true;
                document.getElementById('autoRestartToggle').checked = true;
                document.querySelector('.auto-restart-toggle').classList.add('active');
            }
        }
        
        // æ£€æŸ¥å¹¶è‡ªåŠ¨é‡å¯
        async function checkAutoRestart(currentState) {
            if (!autoRestartEnabled) return;
            
            // å¦‚æœä¸Šä¸€æ¬¡æ˜¯ runningï¼Œç°åœ¨æ˜¯ offlineï¼Œåˆ™è‡ªåŠ¨é‡å¯
            if (lastServerState === 'running' && currentState === 'offline') {
                showToast('æ£€æµ‹åˆ°æœåŠ¡å™¨åœæœºï¼Œæ­£åœ¨è‡ªåŠ¨é‡å¯...', 'success');
                await powerAction('start');
            }
            lastServerState = currentState;
        }
        
        // åˆå§‹åŒ–æ—¶åŠ è½½è®¾ç½®
        window.addEventListener('load', loadAutoRestartSetting);
    </script>
</body>
</html>
